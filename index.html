<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€283å­¦åœ’ç·¨ã€‘AIè¨˜è€…ä»˜ããƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f0f2f5; }
        .setup-card, .display-card { background-color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; }
        #main-bracket-container { display: flex; justify-content: center; padding: 20px; font-size: 12px; overflow-x: auto; border: 1px solid #e5e7eb; background-color: #f9fafb; border-radius: 8px;}
        .bracket-half { display: flex; }
        .bracket-half.right { flex-direction: row-reverse; }
        .bracket-final { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 10px; flex-shrink: 0; min-width: 60px; }
        .bracket-final .final-matchup { border: 2px solid #f59e0b; background-color: #fffbeb; border-radius: 6px; padding: 5px; margin-top: 10px; }
        .bracket-final .winner-box { font-weight: bold; color: #b45309; text-align: center; padding: 10px 20px; white-space: nowrap; font-size: 1.25rem; }
        .bracket-final .final-title { font-weight: 600; color: #4b5563; margin-bottom: 10px; writing-mode: vertical-rl; letter-spacing: 2px; }
        .round { display: flex; flex-direction: column; justify-content: space-around; flex-shrink: 0; width: 180px; padding: 0 10px; }
        .matchup { margin: 8px 0; position: relative; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; transition: all 0.3s; }
        /* === è¿½åŠ ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è©¦åˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« === */
        .player-match-highlight {
            border: 3px solid #f59e0b !important;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.7);
            border-radius: 8px;
        }
        .team-slot { display: flex; align-items: center; background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 4px; transition: background-color 0.3s; position: relative; }
        .team-slot:last-of-type { margin-bottom: 0; }
        .team-name { flex-grow: 1; padding: 6px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-name .rank { font-weight: bold; margin-right: 4px; }
        .team-name .rank-A { color: #ef4444; }
        .team-name .rank-B { color: #f97316; }
        .team-name .rank-C { color: #eab308; }
        .team-name .rank-D { color: #3b82f6; }
        .team-name .rank-E { color: #6b7280; }
        .team-name.seed { font-weight: bold; color: #ca8a04; }
        .score-input { width: 40px; padding: 6px 4px; border-left: 1px solid #e5e7eb; text-align: center; background-color: #fff; }
        .win-btn { background-color: #d1d5db; color: #fff; border: none; padding: 6px 8px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .team-slot:not(.empty) .win-btn { background-color: #3b82f6; }
        .team-slot:not(.empty):hover .win-btn { background-color: #2563eb; }
        .team-slot.winner { background-color: #dbeafe; border-color: #93c5fd; font-weight: 600; }
        .team-slot.loser { background-color: #f3f4f6; opacity: 0.6; }
        .team-slot.empty .team-name { color: #9ca3af; }
        .team-slot.empty .score-input, .team-slot.empty .win-btn, .team-slot.empty .details-btn { display: none; }
        .matchup::after { content: ''; position: absolute; top: 50%; width: 10px; height: 2px; background-color: #cbd5e1; }
        .bracket-half.left .matchup::after { right: -10px; }
        .bracket-half.right .matchup::after { left: -10px; }
        .round.subsequent-round .matchup::before { content: ''; position: absolute; top: -8px; height: calc(100% + 16px); width: 2px; background-color: #cbd5e1; }
        .bracket-half.left .round.subsequent-round .matchup::before { right: -10px; }
        .bracket-half.right .round.subsequent-round .matchup::before { left: -10px; }
        .hidden { display: none; }
        .news-article { border-left: 4px solid #3b82f6; cursor: pointer; transition: background-color 0.2s; }
        #modal-bg { background-color: rgba(0,0,0,0.5); }
        .confirm-modal, .details-modal, .save-load-modal, .newspaper-modal, .manager-modal, .gameover-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .confirm-modal-content, .details-modal-content, .save-load-modal-content, .newspaper-modal-content, .manager-modal-content, .gameover-modal-content { background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .details-modal-content { width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto;}
        .save-load-modal-content { width: 95%; max-width: 500px; }
        .newspaper-modal-content { width: 95%; max-width: 800px; max-height: 95vh; overflow-y: auto; }
        .manager-modal-content { max-width: 500px; width: 95%; }
        .gameover-modal-content { text-align: center; }
        .confirm-modal-content { text-align: center; }
        .loader { text-align: center; padding: 20px; font-style: italic; color: #6b7280; }
        .details-btn { background-color: #6b7280; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: auto; margin-right: 2px; }
        .details-btn:hover { background-color: #4b5563; }
        .matchup-footer { text-align: center; margin-top: 2px; display: flex; justify-content: center; align-items: center; gap: 4px;}
        .stats-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .stats-table th, .stats-table td { border: 1px solid #e5e7eb; padding: 4px 6px; text-align: center; }
        .stats-table th { background-color: #f3f4f6; }
        .stats-table input { width: 100%; border: none; text-align: center; background: transparent;}
        .stats-table input:focus { outline: 1px solid #3b82f6; }
        .modal-body-scroll { max-height: 70vh; overflow-y: auto; }
        #save-code-output { word-break: break-all; background-color: #f3f4f6; padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; user-select: all; }
        .bbs-comment { background-color: #ffffff; border: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 8px; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .match-summary-input { resize: none; height: 40px; }
        .article-error { background-color: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c; padding: 1rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .retry-btn { background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; }
        .retry-btn:hover { background-color: #dc2626; }
        .namco-news-item { cursor: pointer; transition: background-color 0.2s; }
        .namco-news-tag { background-color: #f97316; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; margin-left: 8px; }
        .newspaper-container { font-family: 'Noto Serif JP', serif; padding: 2rem; background-color: #fdfdf8; }
        .newspaper-early { filter: grayscale(100%); border: 2px solid #333; }
        .newspaper-late { border: 2px solid #a10e25; }
        .newspaper-header { text-align: center; border-bottom: 4px double #333; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .newspaper-title { font-size: 1.2rem; font-weight: 700; }
        .newspaper-date { font-size: 0.8rem; }
        .newspaper-content { display: flex; gap: 1.5rem; }
        .newspaper-main-headline { writing-mode: vertical-rl; text-orientation: mixed; font-size: 2.5rem; font-weight: 700; letter-spacing: 0.2em; border-right: 2px solid #333; padding-right: 1rem; margin-right: 1rem; }
        .newspaper-late .newspaper-main-headline { color: #a10e25; border-right-color: #a10e25;}
        .newspaper-body-content { flex-grow: 1; }
        .newspaper-sub-headline { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem; }
        .newspaper-late .newspaper-sub-headline { color: #333; }
        .newspaper-text { font-family: 'Noto Sans JP', sans-serif; column-count: 3; column-gap: 1.5rem; text-align: justify; font-size: 0.9rem; line-height: 1.8; }
        .newspaper-early .newspaper-text { column-count: 2; }
        .newspaper-score-box { border: 2px solid #333; padding: 1rem; text-align: center; margin-top: 1rem; }
        .newspaper-score-box h3 { font-weight: 700; margin-bottom: 0.5rem; font-size: 1.1rem; }
        .newspaper-score-box .score { font-size: 2rem; font-weight: 700; }
        .newspaper-late .newspaper-score-box { background-color: #fff8f8; border-color: #a10e25; }
        .newspaper-image-placeholder { width: 100%; height: 200px; background-color: #e0e0e0; margin: 1rem 0; display: flex; align-items: center; justify-content: center; font-family: 'Noto Sans JP', sans-serif; color: #888; border: 1px dashed #aaa; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container" class="max-w-full mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">283å­¦åœ’ã®ç”²å­åœ’ãƒ­ãƒ¼ãƒ‰</h1>
            <p id="tournament-year-display" class="text-gray-600 mt-2">ï¼ˆAIè¨˜è€…ï¼†ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä»˜ãï¼‰</p>
        </div>

        <div id="setup" class="setup-card">
             <div class="w-full">
                 <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">ç™»å ´ãƒãƒ¼ãƒ  (64ãƒãƒ¼ãƒ )</h2>
                 <textarea id="teams-list" class="w-full h-96 p-3 border border-gray-300 rounded-lg" readonly></textarea>
             </div>
             <div class="mt-8 text-center">
                 <button id="resume-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 shadow-md mb-4 w-full md:w-auto">
                    å†é–‹ï¼ˆåˆã„è¨€è‘‰å…¥åŠ›ï¼‰
                 </button>
                 <button id="generate-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 shadow-md w-full md:w-auto">
                     æ–°ã—ã„å¤ã‚’å§‹ã‚ã‚‹
                 </button>
             </div>
        </div>

        <div id="tournament-display" class="hidden">
             <div id="namco-news-section" class="hidden display-card border-2 border-orange-400">
                 <h2 class="text-xl font-bold text-orange-600 mb-3 text-center">ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h2>
                 <div id="namco-news-content" class="space-y-2"></div>
             </div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <button id="generate-summary-btn" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 shadow-md">
                        ãƒ™ã‚¹ãƒˆ8ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆ
                    </button>
                    <button id="next-tournament-btn" class="hidden bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 shadow-md">
                        æ¬¡ã®å¤§ä¼šã¸é€²ã‚€
                    </button>
                </div>
               <div class="ml-auto">
                    <div class="flex items-center justify-end space-x-2">
                        <button id="skip-r1-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">1å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
                        <button id="skip-r2-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">2å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
                        <button id="skip-r3-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">3å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
                        <span id="save-feedback" class="text-gray-600 font-bold opacity-0 transition-opacity duration-500"></span>
                        <button id="save-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 shadow-md">ã‚»ãƒ¼ãƒ–</button>
                        <button id="reset-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 shadow-md">ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div id="skip-loader-container" class="h-6 text-right mt-1">
                         <span id="skip-loader" class="hidden text-sm text-gray-600 font-bold">è©¦åˆã‚’é€²è¡Œã—ã¦ã„ã¾ã™...</span>
                    </div>
                </div>
            </div>
            <div class="display-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h2>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 rounded-md text-sm">
                    <p><b>æ“ä½œæ–¹æ³•:</b> 283å­¦åœ’ã®è©¦åˆã¯ã€ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦å‹åˆ©ãƒœã‚¿ãƒ³ã€Œâ–¶ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®æŒ‡ç¤ºã«å¾“ã£ã¦é€²ã‚ã¾ã—ã‚‡ã†ï¼</p>
                </div>
                <div id="main-bracket-container"></div>
            </div>
            <div id="news-section" class="display-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">æ³¨ç›®ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
                <div id="news-articles" class="space-y-4">
                    <p class="text-gray-500 text-center">ã¾ã ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>
             <div id="daiya-bbs-section" class="hidden display-card border-4 border-green-600">
                 <h2 id="daiya-bbs-title" class="text-2xl font-bold text-green-800 mb-4 text-center">ã€ç‰¹è¨­ã€‘ä»£çŸ¢æ± å¿œæ´æ²ç¤ºæ¿</h2>
                 <div id="daiya-bbs-comments" class="space-y-3">
                     <p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                 </div>
             </div>
             <div id="bbs-section" class="display-card">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">æ²ç¤ºæ¿ã®åå¿œ</h2>
                 <div id="bbs-comments" class="space-y-3">
                     <p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                 </div>
             </div>
        </div>
    </div>

    <div id="news-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div id="modal-bg" class="absolute inset-0"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full m-4">
            <div class="p-6 modal-body-scroll">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900"></h3>
                <div id="modal-meta" class="text-gray-400 text-sm mt-2 flex items-center gap-4"></div>
                <p id="modal-body" class="mt-4 text-gray-600 whitespace-pre-wrap"></p>
            </div>
            <button id="modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
    <div id="confirm-modal" class="confirm-modal hidden">
        <div class="confirm-modal-content">
            <p id="confirm-modal-text" class="mb-4 text-lg"></p>
            <button id="confirm-ok" class="bg-red-600 text-white px-6 py-2 rounded-lg mr-2">ã¯ã„</button>
            <button id="confirm-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">ã„ã„ãˆ</button>
        </div>
    </div>

    <div id="details-modal" class="details-modal hidden">
        <div class="details-modal-content">
            <h3 class="text-xl font-bold mb-4 text-center">è©¦åˆè©³ç´°å…¥åŠ›</h3>
            <div id="details-modal-body" class="space-y-6"></div>
            <div class="mt-6 text-center">
                <button id="details-save" class="bg-blue-600 text-white px-6 py-2 rounded-lg mr-2">ä¿å­˜</button>
                <button id="details-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <div id="save-load-modal" class="save-load-modal hidden">
        <div class="save-load-modal-content">
            <div class="flex border-b">
                <button id="save-tab-btn" class="px-4 py-2 font-semibold border-b-2 border-blue-500">ã‚»ãƒ¼ãƒ– (åˆã„è¨€è‘‰ã®ç™ºè¡Œ)</button>
                <button id="load-tab-btn" class="px-4 py-2 text-gray-500">ãƒ­ãƒ¼ãƒ‰ (åˆã„è¨€è‘‰ã®å…¥åŠ›)</button>
            </div>
            <div id="save-tab-content" class="py-4">
                <p class="text-sm mb-2">ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ã€Œåˆã„è¨€è‘‰ã€ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                <button id="generate-save-code-btn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">åˆã„è¨€è‘‰ã‚’ç™ºè¡Œ</button>
                <div id="save-code-area" class="hidden mt-4">
                    <p class="text-sm font-bold text-green-600">åˆã„è¨€è‘‰ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</p>
                    <div class="flex items-center mt-2">
                        <div id="save-code-output" class="flex-grow text-xs"></div>
                        <button id="copy-save-code-btn" class="ml-2 bg-gray-200 px-3 py-1 rounded text-xs font-semibold hover:bg-gray-300">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <p id="copy-feedback" class="text-xs text-green-600 mt-1 h-4"></p>
                </div>
            </div>
            <div id="load-tab-content" class="py-4 hidden">
                <p class="text-sm mb-2">ä¿å­˜ã—ãŸã€Œåˆã„è¨€è‘‰ã€ã‚’ä»¥ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                <textarea id="load-code-input" placeholder="åˆã„è¨€è‘‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘" class="w-full h-32 p-2 border rounded mb-2"></textarea>
                <button id="load-from-code-btn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">ã“ã®ãƒ‡ãƒ¼ã‚¿ã§å†é–‹ã™ã‚‹</button>
            </div>
             <div class="mt-4 text-right">
                <button id="save-load-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="newspaper-modal" class="newspaper-modal hidden">
        <div class="newspaper-modal-content">
            <div id="newspaper-modal-body"></div>
            <div class="mt-4 text-center">
                <button id="newspaper-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="manager-modal" class="manager-modal hidden">
        <div class="manager-modal-content">
            <div class="flex items-start gap-4">
                <div>
                    <div class="w-16 h-16 bg-pink-200 rounded-full flex items-center justify-center text-3xl shadow-inner">ğŸ“</div>
                    <p class="text-center font-bold text-sm mt-1 text-pink-700">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</p>
                </div>
                <div class="flex-1">
                    <h3 id="manager-modal-title" class="text-lg font-bold text-gray-800 mb-3 border-b pb-2"></h3>
                    <p id="manager-modal-body" class="text-gray-700 leading-relaxed"></p>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button id="manager-modal-close" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 shadow-md">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="gameover-modal" class="gameover-modal hidden">
        <div class="gameover-modal-content">
            <h3 class="text-2xl font-bold text-red-600 mb-4">GAME OVER</h3>
            <p id="gameover-modal-text" class="mb-6 text-lg"></p>
            <button id="gameover-reset" class="bg-red-600 text-white px-6 py-2 rounded-lg">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const setupEl = document.getElementById('setup');
        const tournamentDisplayEl = document.getElementById('tournament-display');
        const teamsTextarea = document.getElementById('teams-list');
        const generateBtn = document.getElementById('generate-btn');
        const resumeBtn = document.getElementById('resume-btn');
        const resetBtn = document.getElementById('reset-btn');
        const nextTournamentBtn = document.getElementById('next-tournament-btn');
        const saveBtn = document.getElementById('save-btn');
        const saveFeedback = document.getElementById('save-feedback');
        const mainBracketContainer = document.getElementById('main-bracket-container');
        const newsContainer = document.getElementById('news-articles');
        const bbsCommentsContainer = document.getElementById('bbs-comments');
        const daiyaBbsSection = document.getElementById('daiya-bbs-section');
        const daiyaBbsTitle = document.getElementById('daiya-bbs-title');
        const daiyaBbsCommentsContainer = document.getElementById('daiya-bbs-comments');
        const namcoNewsSection = document.getElementById('namco-news-section');
        const namcoNewsContent = document.getElementById('namco-news-content');
        const tournamentYearDisplay = document.getElementById('tournament-year-display');
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        const skipR1Btn = document.getElementById('skip-r1-btn');
        const skipR2Btn = document.getElementById('skip-r2-btn');
        const skipR3Btn = document.getElementById('skip-r3-btn');
        const skipLoader = document.getElementById('skip-loader');

        // Modals
        const newsModal = document.getElementById('news-modal');
        const modalBg = document.getElementById('modal-bg');
        const modalClose = document.getElementById('modal-close');
        const confirmModal = document.getElementById('confirm-modal');
        const detailsModal = document.getElementById('details-modal');
        const saveLoadModal = document.getElementById('save-load-modal');
        const saveTabBtn = document.getElementById('save-tab-btn');
        const loadTabBtn = document.getElementById('load-tab-btn');
        const saveTabContent = document.getElementById('save-tab-content');
        const loadTabContent = document.getElementById('load-tab-content');
        const generateSaveCodeBtn = document.getElementById('generate-save-code-btn');
        const loadFromCodeBtn = document.getElementById('load-from-code-btn');
        const saveLoadCloseBtn = document.getElementById('save-load-close');
        const copySaveCodeBtn = document.getElementById('copy-save-code-btn');
        const newspaperModal = document.getElementById('newspaper-modal');
        const newspaperModalBody = document.getElementById('newspaper-modal-body');
        const newspaperCloseBtn = document.getElementById('newspaper-close');
        // === è¿½åŠ ï¼šæ–°è¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´  ===
        const managerModal = document.getElementById('manager-modal');
        const managerModalTitle = document.getElementById('manager-modal-title');
        const managerModalBody = document.getElementById('manager-modal-body');
        const managerModalClose = document.getElementById('manager-modal-close');
        const gameoverModal = document.getElementById('gameover-modal');
        const gameoverModalText = document.getElementById('gameover-modal-text');
        const gameoverResetBtn = document.getElementById('gameover-reset');
        
        // --- State Management ---
        let tournamentState = {};
        let currentMatchIdForDetails = null;
        // === è¿½åŠ ï¼šã‚²ãƒ¼ãƒ ç”¨å®šæ•°ã¨å¤‰æ•° ===
        const PLAYER_TEAM = "283å­¦åœ’";
        let nextGameAction = null; // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãŸå¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

        // --- Team Master Data (å¤‰æ›´ãªã—) ---
        const TEAM_DATA = { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ };
        const DETAILED_TEAM_DATA = { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ };
        let ROSTER_DATA = {};
        const INITIAL_TEAM_POOL = Object.keys(TEAM_DATA);

        // --- Utility & State Functions (å¤‰æ›´ãªã—) ---
        function shuffleArray(array) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function saveState() { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function uint8ArrayToBase64(bytes) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }

        // --- Custom Alert/Confirm (å¤‰æ›´ãªã—) ---
        function showAlert(message) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function showConfirm(message) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function getRankFromHistoryString(historyString) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        
        // === è¿½åŠ ï¼šã‚²ãƒ¼ãƒ ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ===
        function showManagerComment(title, body, nextActionCallback = null) {
            managerModalTitle.textContent = title;
            managerModalBody.innerHTML = body.replace(/\n/g, '<br>');
            managerModal.classList.remove('hidden');
            managerModal.classList.add('flex');
            nextGameAction = nextActionCallback;
        }

        function showGameOver(message) {
            gameoverModalText.textContent = message;
            gameoverModal.classList.remove('hidden');
            gameoverModal.classList.add('flex');
        }

        // --- Tournament Logic ---
        async function createNewTournament(isNext=false) {
            let teams;
            let seeds = [];

            if (isNext && tournamentState.teamRecords) {
                Object.keys(tournamentState.teamRecords).forEach(teamName => {
                    tournamentState.teamRecords[teamName].previousRank = calculateRank(teamName, tournamentState);
                });

                const lastTournamentTeams = Object.keys(tournamentState.teamRecords)
                    .map(teamName => ({ name: teamName, ...tournamentState.teamRecords[teamName] }))
                    .sort((a, b) => a.lastFinish - b.lastFinish);
                
                seeds = lastTournamentTeams.slice(0, 8).map(t => t.name);
                const nonSeeds = INITIAL_TEAM_POOL.filter(t => !seeds.includes(t));
                let shuffledNonSeeds = shuffleArray(nonSeeds);
                
                // === å¤‰æ›´ï¼š283å­¦åœ’ãŒã‚·ãƒ¼ãƒ‰ã§ãªã„å ´åˆã€å¿…ãšéã‚·ãƒ¼ãƒ‰ã«é…ç½® ===
                if (!seeds.includes(PLAYER_TEAM)) {
                    shuffledNonSeeds = shuffledNonSeeds.filter(t => t !== PLAYER_TEAM);
                    // ã©ã“ã‹ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«æŒ¿å…¥
                    const playerTeamPosition = Math.floor(Math.random() * (shuffledNonSeeds.length + 1));
                    shuffledNonSeeds.splice(playerTeamPosition, 0, PLAYER_TEAM);
                }

                teams = [];
                const seedPositions = [0, 32, 16, 48, 8, 40, 24, 56];
                const seedPlacements = {};
                seeds.forEach((seed, i) => {
                  seedPlacements[seedPositions[i]] = seed;
                });

                let nonSeedIndex = 0;
                for (let i = 0; i < 64; i++) {
                    if (seedPlacements[i]) {
                        teams[i] = seedPlacements[i];
                    } else {
                        teams[i] = shuffledNonSeeds[nonSeedIndex++];
                    }
                }
                tournamentState.tournamentYear++;

            } else {
                tournamentState.tournamentYear = 1;
                tournamentState.teamRecords = {};
                const historicalRanks = INITIAL_TEAM_POOL.map(teamName => ({
                    name: teamName,
                    rank: getRankFromHistoryString(TEAM_DATA[teamName].last)
                }));

                historicalRanks.sort((a, b) => a.rank - b.rank);

                seeds = historicalRanks.slice(0, 8).map(t => t.name);
                const nonSeeds = INITIAL_TEAM_POOL.filter(t => !seeds.includes(t));
                const shuffledNonSeeds = shuffleArray(nonSeeds);
                
                teams = [];
                const seedPositions = [0, 32, 16, 48, 8, 40, 24, 56];
                const seedPlacements = {};
                seeds.forEach((seed, i) => {
                    seedPlacements[seedPositions[i]] = seed;
                });

                let nonSeedIndex = 0;
                for (let i = 0; i < 64; i++) {
                    if (seedPlacements[i]) {
                        teams[i] = seedPlacements[i];
                    } else {
                        teams[i] = shuffledNonSeeds[nonSeedIndex++];
                    }
                }

                INITIAL_TEAM_POOL.forEach(t => {
                    const historicalRank = historicalRanks.find(hr => hr.name === t);
                    tournamentState.teamRecords[t] = { 
                        wins: 0, 
                        losses: 0, 
                        best: null, 
                        lastFinish: historicalRank ? historicalRank.rank : 64,
                        previousRank: null
                    };
                });
            }

            tournamentState.teams = teams;
            tournamentState.matches = {};
            tournamentState.news = [];
            tournamentState.seeds = seeds;
            tournamentState.bbsComments = [];
            tournamentState.daiyaBbsComments = [];
            tournamentState.namcoNews = null;

            const round1Setup = teams.reduce((acc, team, i) => {
                if (i % 2 === 0) acc.push({ team1: team, team2: null });
                else acc[acc.length - 1].team2 = team;
                return acc;
            }, []);

            round1Setup.forEach((match, index) => {
                const side = index < 16 ? 'L' : 'R';
                const matchNum = index < 16 ? index + 1 : index - 15;
                const matchId = `${side}-R1-M${matchNum}`;
                tournamentState.matches[matchId] = { team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '' };
            });

            saveState();
            renderTournament(tournamentState);
            setupEl.classList.add('hidden');
            tournamentDisplayEl.classList.remove('hidden');
            
            newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒå±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
            bbsCommentsContainer.innerHTML = `<div class="loader">AIãŒçµ„ã¿åˆã‚ã›ã‚’åˆ†æä¸­...</div>`;
            namcoNewsSection.classList.remove('hidden');
            namcoNewsContent.innerHTML = `<div class="loader">ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªä¸­...</div>`;

            const [previewArticle, bracketComments, namcoNews] = await Promise.all([
                generateNewsArticle(null, null, null, 'preview', null, null),
                generateBracketReactionComments(tournamentState),
                generateNamcoNews(tournamentState, 'bracket')
            ]);

            if (previewArticle) tournamentState.news.unshift(previewArticle);
            if (bracketComments && bracketComments.length > 0) tournamentState.bbsComments.push(...bracketComments);
            if (namcoNews) tournamentState.namcoNews = namcoNews;

            renderNews(tournamentState.news);
            renderBbsComments(tournamentState.bbsComments);
            renderNamcoNews(tournamentState.namcoNews);
            saveState();

            // === è¿½åŠ ï¼šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º ===
            const playerTeamIndex = tournamentState.teams.indexOf(PLAYER_TEAM);
            if (playerTeamIndex !== -1) {
                const opponentIndex = playerTeamIndex % 2 === 0 ? playerTeamIndex + 1 : playerTeamIndex - 1;
                const opponentName = tournamentState.teams[opponentIndex];
                if (opponentName) {
                    const opponentRank = calculateRank(opponentName, tournamentState);
                    const opponentData = TEAM_DATA[opponentName];
                    const title = `ã„ã‚ˆã„ã‚ˆå¤ã®å¤§ä¼šãŒå§‹ã¾ã‚Šã¾ã™ï¼`;
                    const body = `åˆæˆ¦ã®ç›¸æ‰‹ã¯ã€Œ${opponentName}ã€ã«æ±ºã¾ã‚Šã¾ã—ãŸï¼\n` +
                                 `æˆ¦åŠ›ãƒ©ãƒ³ã‚¯ã¯ã€${opponentRank}ã€‘(${getRankDescription(opponentRank)})ã§ã™ã€‚\n` +
                                 `ç›¸æ‰‹ã®æƒ…å ±ï¼šã€${opponentData.info}ã€\n` +
                                 `ã•ã‚ã€ç”²å­åœ’ã«å‘ã‘ã¦ã€æœ€åˆã®è©¦åˆã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼`;
                    showManagerComment(title, body, () => proceedToPlayerMatch(1));
                }
            } else {
                showAlert("283å­¦åœ’ãŒãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
            }
        }

        // --- Rendering Functions ---
        function renderTournament(data) {
            tournamentYearDisplay.textContent = `${data.tournamentYear}å¹´åº¦ ${PLAYER_TEAM}ã®å¤`;
            renderMainBracket(data);
            renderNews(data.news || []);
            renderBbsComments(data.bbsComments || []);
            renderDaiyaBbsComments(data.daiyaBbsComments || []);
            renderNamcoNews(data.namcoNews);
            checkTournamentProgress();
        }

        function renderMainBracket(data) {
             const { matches, teams } = data;
             
             const bracketContentWrapper = document.createElement('div');
             bracketContentWrapper.className = 'flex flex-row';
             
             const leftBracketEl = document.createElement('div');
             leftBracketEl.className = 'bracket-half left';

             const rightBracketEl = document.createElement('div');
             rightBracketEl.className = 'bracket-half right';

             const finalMatch = matches['F-R1-M1'] || {};
             const leftChampion = matches['L-R5-M1']?.winner || null;
             const rightChampion = matches['R-R5-M1']?.winner || null;
             const finalTeam1 = finalMatch.team1 || leftChampion;
             const finalTeam2 = finalMatch.team2 || rightChampion;

             const finalEl = document.createElement('div');
             finalEl.className = 'bracket-final';
             finalEl.innerHTML = `<div class="final-title">æ±ºå‹</div><div class="final-matchup" data-match-id="F-R1-M1">${createMatchHTML('F-R1-M1', finalTeam1, finalTeam2, finalMatch, data.seeds)}</div><div class="winner-box" id="tournament-winner">${finalMatch.winner ? `ğŸ† ${finalMatch.winner} ğŸ†` : 'ğŸ†'}</div>`;

             const round1Setup = teams.reduce((acc, team, i) => {
                 if (i % 2 === 0) acc.push({ team1: team, team2: null });
                 else acc[acc.length - 1].team2 = team;
                 return acc;
             }, []);
             
             const leftHalfSetup = round1Setup.slice(0, 16);
             const rightHalfSetup = round1Setup.slice(16, 32);

             generateHalf(leftBracketEl, leftHalfSetup, 'L', matches, data.seeds);
             generateHalf(rightBracketEl, rightHalfSetup, 'R', matches, data.seeds);

             mainBracketContainer.innerHTML = '';
             bracketContentWrapper.append(leftBracketEl, finalEl, rightBracketEl);
             mainBracketContainer.appendChild(bracketContentWrapper);

             if (finalMatch.winner) {
                 nextTournamentBtn.classList.remove('hidden');
             } else {
                 nextTournamentBtn.classList.add('hidden');
             }
        }
        function generateHalf(containerEl, setup, side, allMatches, seeds) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function calculateRank(teamName, state) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function createMatchHTML(matchId, team1, team2, dbMatch, seeds = []) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function renderNews(news) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function renderBbsComments(comments) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function renderDaiyaBbsComments(comments) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function renderNamcoNews(news) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }

        // --- AI Reporter Logic (å¤‰æ›´ãªã—) ---
        function parseJsonFromText(text) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        async function fetchWithRetry(payload, maxRetries = 3) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function getRankDescription(rank) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function createNewspaperHtml(articleData, matchData) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        async function generateNewsArticle(winnerName, loserName, dbMatch, matchId, nextOpponentInfo, matchSummary) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        async function generateBbsComments(winnerName, loserName, dbMatch, matchId, matchSummary) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        async function generateBracketReactionComments(state) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        async function generateDaiyaBbsComments(winnerName, loserName, dbMatch, nextOpponentInfo) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        async function generateNamcoNews(state, type, matchData = null) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }

        // --- Match Processing ---
        async function processMatchWin(matchId, winnerName) {
            const dbMatch = tournamentState.matches[matchId];
            if (!dbMatch || dbMatch.winner) return;

            const loserName = dbMatch.team1 === winnerName ? dbMatch.team2 : dbMatch.team1;
            
            // === è¿½åŠ ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ283å­¦åœ’ã‚’è² ã‘ã•ã›ã‚ˆã†ã¨ã—ãŸå ´åˆã®å‡¦ç† ===
            if (winnerName !== PLAYER_TEAM && (dbMatch.team1 === PLAYER_TEAM || dbMatch.team2 === PLAYER_TEAM)) {
                 showAlert("283å­¦åœ’ã¯è² ã‘ã‚‹ã‚ã‘ã«ã¯ã„ãã¾ã›ã‚“ï¼");
                 return;
            }

            dbMatch.winner = winnerName;
            tournamentState.teamRecords[winnerName].wins++;
            tournamentState.teamRecords[loserName].losses++;
            checkTournamentProgress();

            newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒè¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
            const loaderEl = document.createElement('div');
            loaderEl.className = 'loader';
            loaderEl.id = 'bbs-loader';
            loaderEl.textContent = 'AIãŒæ²ç¤ºæ¿ã‚’ç›£è¦–ä¸­...';
            bbsCommentsContainer.prepend(loaderEl);

            const isDaiyaMatch = winnerName === 'ä»£çŸ¢æ±' || loserName === 'ä»£çŸ¢æ±';
            if (isDaiyaMatch) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
            const isNamcoMatch = ["åˆæ˜Ÿå­¦åœ’", "765ç·åˆé«˜æ ¡", "283å­¦åœ’", "ç¾åŸå­¦åœ’", "283å­¦åœ’B"].includes(winnerName) || ["åˆæ˜Ÿå­¦åœ’", "765ç·åˆé«˜æ ¡", "283å­¦åœ’", "ç¾åŸå­¦åœ’", "283å­¦åœ’B"].includes(loserName);
            if (isNamcoMatch) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }

            const [side, roundStr, matchStr] = matchId.split('-');
            const roundNum = side === 'F' ? 6 : parseInt(roundStr.slice(1));
            const matchNum = side === 'F' ? 1 : parseInt(matchStr.slice(1));
            
            // === å¤‰æ›´ï¼šã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã‚’è¿½åŠ  ===
            if (loserName === PLAYER_TEAM) {
                renderTournament(tournamentState);
                saveState();
                showGameOver(`æ®‹å¿µãªãŒã‚‰ã€${roundNum}å›æˆ¦ã§${winnerName}ã«æ•—åŒ—ã—ã¾ã—ãŸ...`);
                return;
            }

            let nextOpponentInfo = null;
            // (nextOpponentInfo ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜)
            if (side !== 'F') {
                 if (roundNum < 5) {
                    const nextMatchNum = Math.ceil(matchNum / 2);
                    const nextMatchId = `${side}-R${roundNum + 1}-M${nextMatchNum}`;
                    const nextMatch = tournamentState.matches[nextMatchId] || {};
                    const isWinnerInFirstSlot = matchNum % 2 !== 0;
                    const opponent = isWinnerInFirstSlot ? nextMatch.team2 : nextMatch.team1;
                    if (opponent) {
                        nextOpponentInfo = { decided: opponent };
                    } else {
                        const otherFeederMatchNum = isWinnerInFirstSlot ? matchNum + 1 : matchNum - 1;
                        const otherFeederMatchId = `${side}-R${roundNum}-M${otherFeederMatchNum}`;
                        const otherFeederMatch = tournamentState.matches[otherFeederMatchId];
                        if (otherFeederMatch) {
                            nextOpponentInfo = { potential: [otherFeederMatch.team1, otherFeederMatch.team2] };
                        }
                    }
                } else if (roundNum === 5) { // Semi-final
                    const otherSide = side === 'L' ? 'R' : 'L';
                    const otherSemiFinalId = `${otherSide}-R5-M1`;
                    const otherSemiFinal = tournamentState.matches[otherSemiFinalId];
                    if (otherSemiFinal && otherSemiFinal.winner) {
                        nextOpponentInfo = { decided: otherSemiFinal.winner };
                    } else if (otherSemiFinal) {
                        nextOpponentInfo = { potential: [otherSemiFinal.team1, otherSemiFinal.team2] };
                    }
                }
            }


            const [article, newComments, daiyaComments, namcoNews] = await Promise.all([
                generateNewsArticle(winnerName, loserName, dbMatch, matchId, nextOpponentInfo, dbMatch.summary),
                generateBbsComments(winnerName, loserName, dbMatch, matchId, dbMatch.summary),
                isDaiyaMatch ? generateDaiyaBbsComments(winnerName, loserName, dbMatch, nextOpponentInfo) : Promise.resolve([]),
                isNamcoMatch ? generateNamcoNews(tournamentState, 'matchResult', { winnerName, loserName, dbMatch }) : Promise.resolve(null)
            ]);

            tournamentState.news.push(article);
            if (newComments && newComments.length > 0) tournamentState.bbsComments.push(...newComments);
            if (daiyaComments && daiyaComments.length > 0) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
            if (namcoNews) tournamentState.namcoNews = namcoNews;
            
            if (side === 'F') { // æ±ºå‹æˆ¦
                updateTournamentFinishRecords();
            } else { // æ±ºå‹ä»¥å¤–
                const nextRoundNum = roundNum + 1;
                const nextMatchNumForId = Math.ceil(matchNum / 2);
                let nextMatchId;

                if (roundNum === 5) {
                    nextMatchId = 'F-R1-M1';
                } else {
                    nextMatchId = `${side}-R${nextRoundNum}-M${nextMatchNumForId}`;
                }

                if (!tournamentState.matches[nextMatchId]) {
                    tournamentState.matches[nextMatchId] = { team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
                }
                
                if(roundNum < 5){
                    const isFirstSlot = matchNum % 2 !== 0;
                    if(isFirstSlot) tournamentState.matches[nextMatchId].team1 = winnerName;
                    else tournamentState.matches[nextMatchId].team2 = winnerName;
                } else { 
                    if(side === 'L') tournamentState.matches[nextMatchId].team1 = winnerName;
                    else tournamentState.matches[nextMatchId].team2 = winnerName;
                }
            }
            
            renderTournament(tournamentState);
            saveState();

            // === è¿½åŠ ï¼šå‹åˆ©å¾Œã®ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ ===
            if (winnerName === PLAYER_TEAM) {
                let managerTitle = '';
                let managerBody = '';
                let nextActionCallback = null;

                if (matchId.startsWith('F-')) { // æ±ºå‹æˆ¦å‹åˆ©
                    managerTitle = "å„ªå‹ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼";
                    managerBody = "ã‚„ã‚Šã¾ã—ãŸã­ï¼ã¤ã„ã«çœŒå¤§ä¼šå„ªå‹ã€ç”²å­åœ’å‡ºå ´ã§ã™ï¼\n" +
                                  "ã¿ã‚“ãªã®åŠªåŠ›ãŒå®Ÿã‚Šã¾ã—ãŸï¼æœ¬å½“ã«ã€æœ¬å½“ã«ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼";
                } else if (nextOpponentInfo) {
                    const nextRoundForPlayer = roundNum + 1;
                    nextActionCallback = () => proceedToPlayerMatch(nextRoundForPlayer);
                    if (nextOpponentInfo.decided) {
                        const opponentName = nextOpponentInfo.decided;
                        const opponentRank = calculateRank(opponentName, tournamentState);
                        const opponentData = TEAM_DATA[opponentName];
                        managerTitle = `${roundNum}å›æˆ¦çªç ´ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼`;
                        managerBody = `æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯ã€Œ${opponentName}ã€ã§ã™ï¼\n` +
                                      `æˆ¦åŠ›ãƒ©ãƒ³ã‚¯ã¯ã€${opponentRank}ã€‘(${getRankDescription(opponentRank)})ã§ã™ã€‚\n` +
                                      `æƒ…å ±ï¼šã€${opponentData.info}ã€\n` +
                                      "æ°—ã‚’å¼•ãç· ã‚ã¦ã„ãã¾ã—ã‚‡ã†ï¼";
                    } else if (nextOpponentInfo.potential) {
                         const [pot1, pot2] = nextOpponentInfo.potential;
                         managerTitle = `${roundNum}å›æˆ¦çªç ´ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼`;
                         managerBody = `æ¬¡ã®å¯¾æˆ¦ã¯ã€ã€Œ${pot1}ã€ã¨ã€Œ${pot2}ã€ã®å‹è€…ã¨ãªã‚Šã¾ã™ã€‚\n` +
                                       "ã©ã¡ã‚‰ãŒæ¥ã¦ã‚‚ã„ã„ã‚ˆã†ã«ã€ã—ã£ã‹ã‚Šæº–å‚™ã—ã¾ã—ã‚‡ã†ï¼";
                    }
                }
                setTimeout(() => showManagerComment(managerTitle, managerBody, nextActionCallback), 500);
            }
        }
        function getRankString(rank) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function updateTournamentFinishRecords() { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }

        // --- Details Modal Logic (å¤‰æ›´ãªã—) ---
        function openDetailsModal(matchId) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function createInningScoreTable(team1, team2, data) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function createStatsTable(type, title, data, headers, teamName) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function saveDetailedStats() { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function parseStatsTable(tableEl) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }


        // --- Event Listeners (ä¸€éƒ¨å¤‰æ›´) ---
        document.body.addEventListener('click', async (e) => {
            if (e.target.matches('.win-btn')) { /* (processMatchWinå‘¼ã³å‡ºã—éƒ¨åˆ†ã¯ä¸Šè¨˜ã§ä¿®æ­£æ¸ˆã¿) */ }
            if (e.target.matches('.details-btn')) { /* (å¤‰æ›´ãªã—) */ }
            if (e.target.matches('.add-row-btn')) { /* (å¤‰æ›´ãªã—) */ }
            if (e.target.matches('.retry-btn')) { /* (å¤‰æ›´ãªã—) */ }
            if (e.target.matches('.news-article-btn')) { /* (å¤‰æ›´ãªã—) */ }
            if (e.target.matches('.newspaper-view-btn')) { /* (å¤‰æ›´ãªã—) */ }
        });
        document.body.addEventListener('input', (e) => { /* (å¤‰æ›´ãªã—) */ });
        
        // --- Skip Round Feature (ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ã«åˆã‚ã›ã¦å¤‰æ›´) ---
        async function proceedToPlayerMatch(roundNumber) {
            skipLoader.classList.remove('hidden');
            
            // 283å­¦åœ’ã®è©¦åˆIDã‚’ç‰¹å®š
            let playerMatchId = null;
            for (const matchId in tournamentState.matches) {
                const match = tournamentState.matches[matchId];
                if (matchId.includes(`-R${roundNumber}-`) && (match.team1 === PLAYER_TEAM || match.team2 === PLAYER_TEAM)) {
                    playerMatchId = matchId;
                    break;
                }
            }

            // NPCæˆ¦ã‚’è‡ªå‹•é€²è¡Œ
            for (const matchId in tournamentState.matches) {
                if (matchId.includes(`-R${roundNumber}-`) && matchId !== playerMatchId) {
                    const match = tournamentState.matches[matchId];
                    if (!match || match.winner || !match.team1 || !match.team2) continue;
                    
                    const { team1, team2 } = match;
                    const rank1 = calculateRank(team1, tournamentState);
                    const rank2 = calculateRank(team2, tournamentState);
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    
                    let winnerName, loserName, winnerRank, loserRank;
                    const higherRankTeam = rankValues[rank1] >= rankValues[rank2] ? team1 : team2;
                    const lowerRankTeam = rankValues[rank1] >= rankValues[rank2] ? team2 : team1;
                    winnerName = higherRankTeam;
                    loserName = lowerRankTeam;
                    
                    const [winnerScore, loserScore] = generateAutoScore(calculateRank(winnerName, tournamentState), calculateRank(loserName, tournamentState));

                    match.winner = winnerName;
                    match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
                    match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;
                    
                    tournamentState.teamRecords[winnerName].wins++;
                    tournamentState.teamRecords[loserName].losses++;
                    
                    // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹
                    const [side, , matchStr] = matchId.split('-');
                    const matchNum = parseInt(matchStr.slice(1));
                    const nextRoundNum = roundNumber + 1;
                    const nextMatchNum = Math.ceil(matchNum / 2);
                    let nextMatchId;
                    if (roundNumber === 5) nextMatchId = 'F-R1-M1';
                    else nextMatchId = `${side}-R${nextRoundNum}-M${nextMatchNum}`;
                    
                    if (!tournamentState.matches[nextMatchId]) {
                        tournamentState.matches[nextMatchId] = { team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
                    }
                    if (roundNumber < 5) {
                        if (matchNum % 2 !== 0) tournamentState.matches[nextMatchId].team1 = winnerName;
                        else tournamentState.matches[nextMatchId].team2 = winnerName;
                    } else if(roundNumber === 5) {
                        if(side === 'L') tournamentState.matches[nextMatchId].team1 = winnerName;
                        else tournamentState.matches[nextMatchId].team2 = winnerName;
                    }
                }
            }

            skipLoader.classList.add('hidden');
            renderTournament(tournamentState);
            saveState();

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è©¦åˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (playerMatchId) {
                const playerMatchEl = document.querySelector(`.matchup[data-match-id="${playerMatchId}"]`);
                if (playerMatchEl) {
                    playerMatchEl.classList.add('player-match-highlight');
                    playerMatchEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                }
            }
        }

        function generateAutoScore(rankWinner, rankLoser) { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }
        function checkTournamentProgress() { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }

        // --- Initial Load & Setup (å¤‰æ›´ãªã—) ---
        async function initializeApp() { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ }

        generateBtn.addEventListener('click', async () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        resumeBtn.addEventListener('click', () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        nextTournamentBtn.addEventListener('click', () => createNewTournament(true));
        resetBtn.addEventListener('click', async () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        saveBtn.addEventListener('click', () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        
        // Modal close events
        modalBg.addEventListener('click', () => newsModal.classList.add('hidden'));
        modalClose.addEventListener('click', () => newsModal.classList.add('hidden'));
        document.getElementById('details-save').addEventListener('click', saveDetailedStats);
        document.getElementById('details-close').addEventListener('click', () => detailsModal.classList.add('hidden'));
        saveLoadCloseBtn.addEventListener('click', () => saveLoadModal.classList.add('hidden'));
        newspaperCloseBtn.addEventListener('click', () => newspaperModal.classList.add('hidden'));
        // === è¿½åŠ ï¼šæ–°è¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ ===
        managerModalClose.addEventListener('click', () => {
            managerModal.classList.add('hidden');
            if (typeof nextGameAction === 'function') {
                nextGameAction();
                nextGameAction = null; // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€åº¦å®Ÿè¡Œã—ãŸã‚‰ã‚¯ãƒªã‚¢
            }
        });
        gameoverResetBtn.addEventListener('click', () => {
            localStorage.clear();
            location.reload();
        });

        // Save/Load Tab Logic (å¤‰æ›´ãªã—)
        saveTabBtn.addEventListener('click', () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        loadTabBtn.addEventListener('click', () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        generateSaveCodeBtn.addEventListener('click', () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        copySaveCodeBtn.addEventListener('click', () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });
        loadFromCodeBtn.addEventListener('click', () => { /* (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãªã®ã§çœç•¥) */ });

        initializeApp();

        // === å‰Šé™¤ï¼šã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ã«åˆã‚ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã¯ä¸è¦ ===
        // skipR1Btn, skipR2Btn, skipR3Btn ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ã“ã“ã§ã¯çœç•¥ã—ã¾ã™ã€‚
        // ã‚‚ã—æ®‹ã™å ´åˆã¯ã€ã‚²ãƒ¼ãƒ ã®é€²è¡Œã‚’å£Šã•ãªã„ã‚ˆã†ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
    </script>
</body>
</html>